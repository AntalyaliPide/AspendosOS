name: Aptos Final - V4 Safe Edition
on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Kodlari Cek
        uses: actions/checkout@v4

      - name: Gerekli Araclar
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso grub-pc-bin grub-common mtools squashfs-tools debootstrap

      - name: Aptos Elite Insa Et
        run: |
          mkdir -p iso/boot/grub
          mkdir -p iso/live
          
          # 1. Temel Sistem Kurulumu
          sudo debootstrap --arch=amd64 bookworm chroot-dir http://deb.debian.org/debian/
          
          # 2. SISTEMIN ICINDE OPERASYON (En Sade Hal)
          sudo chroot chroot-dir /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y linux-image-amd64 live-boot sudo gnome-core neofetch locales
            
            # Sistem Kimliği
            echo 'aptos' > /etc/hostname
            
            # Kullanıcı: aspendos
            useradd -m -g users -G sudo -s /bin/bash aspendos
            echo 'aspendos:123' | chpasswd
            echo 'aspendos ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/aspendos
            
            # Yerel Ayarlar
            echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen
            locale-gen
          "

          # 3. KERNEL VE INITRD TESPITI (Hata 2'yi Burası Çözer)
          # Wildcard yerine tam yolu değişkene atıyoruz
          VMLINUZ_FILE=$(ls chroot-dir/boot/vmlinuz-* | head -n 1)
          INITRD_FILE=$(ls chroot-dir/boot/initrd.img-* | head -n 1)
          
          sudo cp -v "$VMLINUZ_FILE" iso/boot/vmlinuz
          sudo cp -v "$INITRD_FILE" iso/boot/initrd.img

          # 4. DOSYA SISTEMINI SIKISTIRMA
          sudo mksquashfs chroot-dir iso/live/filesystem.squashfs -noappend -comp xz

          # 5. GRUB YAPILANDIRMASI (En Basit Mod)
          echo 'set default=0
          set timeout=5
          menuentry "Aptos Elite" {
            linux /boot/vmlinuz boot=live quiet splash
            initrd /boot/initrd.img
          }' > iso/boot/grub/grub.cfg
          
          # 6. ISO OLUSTURMA
          sudo grub-mkrescue -o Aptos-Elite-V4.iso iso

      - name: ISOyu Gonder
        uses: actions/upload-artifact@v4
        with:
          name: Aptos-Elite-V4-Build
          path: Aptos-Elite-V4.iso
